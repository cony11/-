<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šè†¨èª¿æ•´ç‰ˆé€€ä¼‘è²¡å‹™è¦åŠƒè¨ˆç®—æ©Ÿ</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Chart.js ç¹ªè£½åœ–è¡¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- è¨­å®š Tailwind é…ç½®ï¼Œä½¿ç”¨ Inter å­—é«” -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* è‡ªå®šç¾©æ¨£å¼ */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f7f7f7;
        }
        .input-group label {
            font-weight: 500;
            color: #333;
        }
        .result-box {
            @apply p-6 mt-6 bg-white border-4 border-indigo-600 rounded-xl shadow-2xl;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
            min-height: 300px;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

<div class="max-w-5xl mx-auto bg-white p-6 sm:p-10 rounded-2xl shadow-xl">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-indigo-700 mb-2">
        ğŸ’° é€šè†¨èª¿æ•´ç‰ˆé€€ä¼‘è²¡å‹™è¦åŠƒè¨ˆç®—æ©Ÿ
    </h1>
    <p class="text-center text-gray-500 mb-8">
        è©¦ç®—çµæœå·²æ‰£é™¤é€šè†¨ï¼Œé¡¯ç¤ºé€€ä¼‘å¾Œçš„**å¯¦éš›è³¼è²·åŠ›**ã€‚
    </p>

    <!-- è¼¸å…¥å€å¡Š -->
    <div id="input-container" class="space-y-6">

        <h2 class="text-xl font-bold text-indigo-700 border-b pb-2 mb-4">ç´¯ç©éšæ®µ (é€€ä¼‘å‰)</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="input-group">
                <label for="initialCapital" class="block text-gray-700 mb-1">æœŸåˆæœ¬é‡‘ (TWD)</label>
                <input type="number" id="initialCapital" value="100000" min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" oninput="calculateRetirement()">
            </div>
            <div class="input-group">
                <label for="monthlySaving" class="block text-gray-700 mb-1">æ¯æœˆå®šæœŸå®šé¡ (TWD)</label>
                <input type="number" id="monthlySaving" value="15000" min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" oninput="calculateRetirement()">
            </div>
            <div class="input-group">
                <label for="currentAge" class="block text-gray-700 mb-1">ç¾åœ¨å¹¾æ­² (å¹´é½¡)</label>
                <input type="number" id="currentAge" value="30" min="18" max="99" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" oninput="calculateRetirement()">
            </div>
            <div class="input-group">
                <label for="retirementAge" class="block text-gray-700 mb-1">é è¨ˆé€€ä¼‘å¹´é½¡ (å¹´é½¡)</label>
                <input type="number" id="retirementAge" value="50" min="19" max="100" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" oninput="calculateRetirement()">
            </div>
        </div>
        <!-- é¡¯ç¤ºè¨ˆç®—å‡ºçš„ç´¯ç©æœŸå¹´æ•¸ -->
        <p class="text-sm text-gray-600 mt-2">
            **è·é›¢é€€ä¼‘é‚„æœ‰å¹¾å¹´ (ç´¯ç©æœŸ):** <span id="accumulationYearsDisplay" class="font-bold text-indigo-700">0 å¹´</span>
        </p>

        <h2 class="text-xl font-bold text-indigo-700 border-b pb-2 mb-4 pt-6">å ±é…¬èˆ‡é€šè†¨ç‡</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="input-group">
                <label for="annualRate" class="block text-gray-700 mb-1">é æœŸå¹´åŒ–å ±é…¬ç‡ (%)</label>
                <input type="number" id="annualRate" value="7" min="0" step="0.1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" oninput="calculateRetirement()">
            </div>
            <div class="input-group">
                <label for="inflationRate" class="block text-gray-700 mb-1">é æœŸå¹´åŒ–é€šè†¨ç‡ (%)</label>
                <input type="number" id="inflationRate" value="3" min="0" step="0.1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" oninput="calculateRetirement()">
            </div>
            <div class="input-group">
                <label for="retirementYears" class="block text-gray-700 mb-1">é€€ä¼‘å¾Œç”Ÿæ´»å¹´æ•¸ (å¹´)</label>
                <input type="number" id="retirementYears" value="30" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" oninput="calculateRetirement()">
            </div>
        </div>
        <p class="text-sm text-gray-600 mt-2">
            **å¯¦éš›å¹´åŒ–å ±é…¬ç‡ (å·²æ‰£é€šè†¨):** <span id="realRateDisplay" class="font-bold text-green-700">0%</span>
        </p>

    </div>

    <!-- çµæœå±•ç¤ºå€å¡Š -->
    <div id="result" class="result-box text-center">
        <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">åˆ†æçµæœèˆ‡è³‡ç”¢ç‹€æ³ (ä»¥ç›®å‰è³¼è²·åŠ›è¨ˆç®—)</h3>
        
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-left">
            <div class="bg-indigo-50 p-4 rounded-lg">
                <p class="text-sm text-gray-500">é€€ä¼‘æ™‚ç´¯ç©ç¸½è³‡ç”¢ (ç•¶å‰è³¼è²·åŠ›)</p>
                <p class="text-2xl font-extrabold text-indigo-600" id="accumulatedAssets">TWD 0</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
                <p class="text-sm text-gray-500">é€€ä¼‘å¾Œæ¯å¹´å¯ç”¨ (ç•¶å‰è³¼è²·åŠ›)</p>
                <p class="text-2xl font-extrabold text-green-600" id="annualWithdrawal">TWD 0</p>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg">
                <p class="text-sm text-gray-500">é€€ä¼‘å¾Œæ¯æœˆå¯ç”¨ (ç•¶å‰è³¼è²·åŠ›)</p>
                <p class="text-2xl font-extrabold text-yellow-600" id="monthlyWithdrawal">TWD 0</p>
            </div>
        </div>
        
        <p id="alertMessage" class="mt-4 text-red-500 font-semibold hidden">è¼¸å…¥æœ‰èª¤ï¼Œè«‹æª¢æŸ¥åƒæ•¸ã€‚</p>
    </div>
    
    <!-- åœ–è¡¨å€å¡Š -->
    <div class="mt-8">
        <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">è³‡ç”¢è¶¨å‹¢é•·æ¢åœ– (å¹´)</h3>
        <div class="chart-container">
            <canvas id="assetChart"></canvas>
        </div>
    </div>

</div>

<script>
    let assetChart; // Chart.js å¯¦ä¾‹

    // æ ¼å¼åŒ–æ•¸å­—ç‚ºå°å¹£
    const formatter = new Intl.NumberFormat('zh-TW', {
        style: 'currency',
        currency: 'TWD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    });

    // æ ¸å¿ƒé€€ä¼‘è²¡å‹™è¨ˆç®—å‡½æ•¸
    function calculateRetirement() {
        const PV_initial = parseFloat(document.getElementById('initialCapital').value) || 0;
        const PMT = parseFloat(document.getElementById('monthlySaving').value) || 0;
        
        // åç›®å ±é…¬ç‡ (Nominal Rate)
        const R_nominal_annual = (parseFloat(document.getElementById('annualRate').value) / 100) || 0;
        // é€šè†¨ç‡ (Inflation Rate)
        const I_annual = (parseFloat(document.getElementById('inflationRate').value) / 100) || 0;

        const T_ret = parseFloat(document.getElementById('retirementYears').value) || 1;
        
        const currentAge = parseFloat(document.getElementById('currentAge').value) || 0;
        const retirementAge = parseFloat(document.getElementById('retirementAge').value) || 0;
        
        const T_acc = retirementAge - currentAge; // ç´¯ç©æœŸå¹´æ•¸

        const alertElement = document.getElementById('alertMessage');
        alertElement.classList.add('hidden');
        document.getElementById('accumulationYearsDisplay').textContent = `${T_acc > 0 ? T_acc : 0} å¹´`;

        // è¨ˆç®—å¯¦éš›å ±é…¬ç‡ (Real Rate)
        // è²»é›ªå…¬å¼ç°¡åŒ–: Real Rate â‰ˆ Nominal Rate - Inflation Rate (R_real â‰ˆ R_nominal - I)
        const R_real_annual = R_nominal_annual - I_annual;
        const R_real_monthly = R_real_annual / 12;

        document.getElementById('realRateDisplay').textContent = `${(R_real_annual * 100).toFixed(2)}%`;


        // æª¢æŸ¥åŸºæœ¬è¼¸å…¥å’Œå¹´é½¡é‚è¼¯
        if (currentAge <= 0 || retirementAge <= 0 || T_acc <= 0 || T_ret <= 0) {
            alertElement.textContent = 'è«‹æª¢æŸ¥è¼¸å…¥åƒæ•¸ï¼šç¾åœ¨å¹´é½¡ã€é€€ä¼‘å¹´é½¡å’Œé€€ä¼‘å¹´æ•¸éœ€å¤§æ–¼ 0ï¼Œä¸”é€€ä¼‘å¹´é½¡éœ€å¤§æ–¼ç¾åœ¨å¹´é½¡ã€‚';
            alertElement.classList.remove('hidden');
            displayResults(0, 0, 0); // æ¸…ç©ºçµæœ
            updateChart([], []); // æ¸…ç©ºåœ–è¡¨
            return;
        }

        // --- ç´¯ç©éšæ®µ (Accumulation Phase) è¨ˆç®— ---
        // ä½¿ç”¨å¯¦éš›å ±é…¬ç‡è¨ˆç®—æœªä¾†è³‡ç”¢çš„å¯¦éš›è³¼è²·åŠ› (Real Future Value)
        const N_periods = T_acc * 12;

        let FV_acc_real = 0; // é€€ä¼‘æ™‚ç´¯ç©çš„è³‡ç”¢ç¸½é¡ (ä»¥ç•¶å‰è³¼è²·åŠ›è¨ˆ)

        if (R_real_monthly === 0) {
            // å¯¦éš›å ±é…¬ç‡ç‚ºé›¶ï¼Œè³‡ç”¢åƒ…å¢åŠ æœ¬é‡‘å’Œå®šæœŸæŠ•å…¥
            FV_acc_real = PV_initial + (PMT * N_periods);
        } else {
            const futureValueFactor = Math.pow(1 + R_real_monthly, N_periods);

            // 1. æœŸåˆæœ¬é‡‘çš„æœªä¾†å¯¦éš›åƒ¹å€¼ (Real FV of PV)
            const FV_PV_real = PV_initial * futureValueFactor;

            // 2. å®šæœŸæŠ•å…¥çš„æœªä¾†å¯¦éš›åƒ¹å€¼ (Real FV of PMT)
            // é€™è£¡å‡è¨­æ¯å€‹æœˆçš„å®šæœŸæŠ•å…¥ PMT ä¹Ÿç¶­æŒç•¶å‰è³¼è²·åŠ› (å³æ¯å¹´æŠ•å…¥é‡‘é¡æœƒéš¨é€šè†¨å¢åŠ ï¼Œä½†æˆ‘å€‘è¨ˆç®—çš„æ˜¯å…¶è³¼è²·åŠ›)
            const FV_PMT_real = PMT * ((futureValueFactor - 1) / R_real_monthly);
            
            FV_acc_real = FV_PV_real + FV_PMT_real;
        }
        
        FV_acc_real = Math.round(FV_acc_real); // é€€ä¼‘æ™‚ç¸½è³‡ç”¢ (å››æ¨äº”å…¥)


        // --- æé ˜éšæ®µ (Withdrawal Phase) è¨ˆç®— ---
        let annualWithdrawal = 0;
        let monthlyWithdrawal = 0;
        
        // ä½¿ç”¨å¹´é‡‘æé ˜ (Annuity) - ä½¿ç”¨å¯¦éš›å ±é…¬ç‡ï¼Œè¨ˆç®—æ¯å¹´å¯æé ˜çš„å›ºå®šè³¼è²·åŠ›é‡‘é¡
        // PMT = (PV * R_real_annual) / [1 - (1 + R_real_annual)^(-T_ret)]
        if (R_real_annual === 0) {
            // å¯¦éš›å ±é…¬ç‡ç‚ºé›¶
            annualWithdrawal = FV_acc_real / T_ret;
        } else {
            annualWithdrawal = (FV_acc_real * R_real_annual) / (1 - Math.pow(1 + R_real_annual, -T_ret));
        }

        annualWithdrawal = Math.round(annualWithdrawal);
        monthlyWithdrawal = Math.round(annualWithdrawal / 12);
        
        // --- è¦–è¦ºåŒ–æ•¸æ“šæº–å‚™ (Accumulation + Drawdown) ---
        const yearsArray = [];
        const assetsArray = [];
        let currentAssetReal = PV_initial;
        
        // ç´¯ç©æœŸæ•¸æ“š
        for (let y = 1; y <= T_acc; y++) {
            yearsArray.push(`ç´¯ç© ${y} å¹´`);
            const N_y_periods = y * 12;
            let FV_y_real = 0;

            if (R_real_monthly === 0) {
                FV_y_real = PV_initial + (PMT * N_y_periods);
            } else {
                const futureValueFactor_y = Math.pow(1 + R_real_monthly, N_y_periods);
                const FV_PV_y_real = PV_initial * futureValueFactor_y;
                const FV_PMT_y_real = PMT * ((futureValueFactor_y - 1) / R_real_monthly);
                FV_y_real = FV_PV_y_real + FV_PMT_y_real;
            }
            currentAssetReal = Math.round(FV_y_real);
            assetsArray.push(currentAssetReal);
        }

        // æé ˜æœŸæ•¸æ“š
        currentAssetReal = FV_acc_real; // å¾ç´¯ç©çš„ç¸½è³‡ç”¢å¯¦éš›è³¼è²·åŠ›é–‹å§‹
        for (let y = 1; y <= T_ret; y++) {
            yearsArray.push(`æé ˜ ${y} å¹´`);
            let startOfYearReal = currentAssetReal;
            let endOfYearReal = 0;

            if (R_real_annual === 0) {
                 // æ¯å¹´æé ˜ annualWithdrawal (è³¼è²·åŠ›ä¸è®Š)
                 endOfYearReal = Math.max(0, startOfYearReal - annualWithdrawal);
            } else {
                // æ¯å¹´æˆé•· R_real_annualï¼Œç„¶å¾Œæ¸›å»æé ˜é¡
                const realInterestGained = startOfYearReal * R_real_annual;
                endOfYearReal = Math.max(0, startOfYearReal + realInterestGained - annualWithdrawal);
            }
            
            // ç”±æ–¼ Chart.js åœ–è¡¨é¡¯ç¤ºçš„æ˜¯ "å¹´çµ‚" é¤˜é¡ï¼Œæˆ‘å€‘å°‡é€™å€‹å€¼åŠ å…¥
            assetsArray.push(Math.round(endOfYearReal)); 
            currentAssetReal = endOfYearReal;
        }


        // --- é¡¯ç¤ºçµæœèˆ‡ç¹ªè£½åœ–è¡¨ ---
        displayResults(FV_acc_real, annualWithdrawal, monthlyWithdrawal);
        updateChart(yearsArray, assetsArray);
    }

    // é¡¯ç¤ºçµæœ
    function displayResults(accumulated, annual, monthly) {
        document.getElementById('accumulatedAssets').textContent = formatter.format(accumulated);
        document.getElementById('annualWithdrawal').textContent = formatter.format(annual);
        document.getElementById('monthlyWithdrawal').textContent = formatter.format(monthly);
    }

    // æ›´æ–° Chart.js åœ–è¡¨
    function updateChart(labels, data) {
        const ctx = document.getElementById('assetChart').getContext('2d');
        
        if (assetChart) {
            assetChart.destroy(); // éŠ·æ¯€èˆŠåœ–è¡¨
        }

        // æ‰¾åˆ°ç´¯ç©æœŸçµæŸé»çš„ç´¢å¼•
        const accumulationEndIndex = labels.findIndex(label => label.includes('ç´¯ç©'));
        const backgroundColor = labels.map((label, index) => {
            if (index <= accumulationEndIndex) {
                return '#4c51bf'; // è—è‰² (ç´¯ç©æœŸ)
            } else {
                return '#38a169'; // ç¶ è‰² (æé ˜æœŸ)
            }
        });


        assetChart = new Chart(ctx, {
            type: 'bar', // ä½¿ç”¨é•·æ¢åœ–
            data: {
                labels: labels,
                datasets: [{
                    label: 'å¹´çµ‚è³‡ç”¢é¤˜é¡ (ç•¶å‰è³¼è²·åŠ›/TWD)',
                    data: data,
                    backgroundColor: backgroundColor,
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'è¨ˆç•«å¹´åº¦'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        stacked: true,
                        title: {
                            display: true,
                            text: 'è³‡ç”¢ç¸½é¡ (ç•¶å‰è³¼è²·åŠ›/TWD)'
                        },
                        ticks: {
                            callback: function(value, index, values) {
                                // æ ¼å¼åŒ– Y è»¸æ•¸å­—ç‚º K/M å–®ä½
                                if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                                if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                                return value;
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                         callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += formatter.format(context.parsed.y);
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
    window.onload = () => {
        calculateRetirement(); // é¦–æ¬¡è¼‰å…¥å³è¨ˆç®—ä¸¦ç¹ªåœ–
    };
</script>

</body>
</html>